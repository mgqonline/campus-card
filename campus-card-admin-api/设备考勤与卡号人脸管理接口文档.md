# 设备考勤与卡号人脸管理接口文档

## 1. 设备考勤信息入库接口

### 1.1 刷卡考勤接口

#### 1.1.1 直接入库刷卡考勤
- **接口路径**: `POST /api/v1/attendance/ingest/card`
- **接口描述**: 直接将刷卡考勤记录入库，不经过队列
- **请求参数**:
```json
{
  "deviceId": 1,                    // Long, 可选, 设备ID
  "cardNo": "C20240101001",         // String, 必填, 卡号
  "attendanceType": "in",           // String, 可选, 考勤类型 (in/out), 默认"in"
  "attendanceTime": "2025-01-20T08:30:00",  // LocalDateTime, 可选, 考勤时间, 默认当前时间
  "remark": "正常刷卡"               // String, 可选, 备注
}
```
- **响应参数**:
```json
{
  "code": 200,
  "message": "success",
  "data": {
    "id": 1,                        // Long, 考勤记录ID
    "studentId": 1001,              // Long, 学生ID
    "studentName": "张三",           // String, 学生姓名
    "studentNo": "2024001",         // String, 学号
    "classId": 1,                   // Long, 班级ID
    "className": "计算机1班",        // String, 班级名称
    "deviceId": 1,                  // Long, 设备ID
    "deviceName": "东门闸机",        // String, 设备名称
    "attendanceTime": "2025-01-20T08:30:00",  // LocalDateTime, 考勤时间
    "attendanceType": "in",         // String, 考勤类型
    "checkType": "card",            // String, 考勤方式
    "photoUrl": null,               // String, 照片URL (刷卡为null)
    "status": "normal",             // String, 考勤状态 (normal/late/early/absence)
    "remark": "正常刷卡"             // String, 备注
  }
}
```

#### 1.1.2 队列入库刷卡考勤
- **接口路径**: `POST /api/v1/attendance/ingest/queue/card`
- **接口描述**: 将刷卡考勤记录加入队列，异步处理
- **请求参数**: 同直接入库接口
- **响应参数**:
```json
{
  "code": 200,
  "message": "success",
  "data": "queued"                  // String, 入队成功标识
}
```

#### 1.1.3 批量队列入库刷卡考勤
- **接口路径**: `POST /api/v1/attendance/ingest/queue/card/bulk`
- **接口描述**: 批量将刷卡考勤记录加入队列
- **请求参数**: 刷卡考勤请求数组
```json
[
  {
    "deviceId": 1,
    "cardNo": "C20240101001",
    "attendanceType": "in",
    "attendanceTime": "2025-01-20T08:30:00",
    "remark": "批量刷卡1"
  },
  {
    "deviceId": 1,
    "cardNo": "C20240101002",
    "attendanceType": "in",
    "attendanceTime": "2025-01-20T08:31:00",
    "remark": "批量刷卡2"
  }
]
```
- **响应参数**:
```json
{
  "code": 200,
  "message": "success",
  "data": "queued"
}
```

### 1.2 人脸考勤接口

#### 1.2.1 直接入库人脸考勤
- **接口路径**: `POST /api/v1/attendance/ingest/face`
- **接口描述**: 直接将人脸考勤记录入库，不经过队列
- **请求参数**:
```json
{
  "deviceId": 1,                    // Long, 可选, 设备ID
  "personType": "STUDENT",          // String, 必填, 人员类型 (STUDENT/TEACHER)
  "personId": "2024001",            // String, 必填, 人员ID (学号/工号)
  "attendanceType": "in",           // String, 可选, 考勤类型 (in/out), 默认"in"
  "attendanceTime": "2025-01-20T08:30:00",  // LocalDateTime, 可选, 考勤时间, 默认当前时间
  "score": 0.95,                   // Double, 可选, 识别分数
  "success": true,                  // Boolean, 可选, 识别是否成功
  "photoUrl": "http://example.com/photo.jpg",  // String, 可选, 照片URL
  "remark": "人脸识别成功"           // String, 可选, 备注
}
```
- **响应参数**:
```json
{
  "code": 200,
  "message": "success",
  "data": {
    "logged": true,                 // Boolean, 是否记录日志
    "record": {                     // AttendanceRecord, 考勤记录 (仅成功时有值)
      "id": 1,
      "studentId": 1001,
      "studentName": "张三",
      "studentNo": "2024001",
      "classId": 1,
      "className": "计算机1班",
      "deviceId": 1,
      "deviceName": "东门闸机",
      "attendanceTime": "2025-01-20T08:30:00",
      "attendanceType": "in",
      "checkType": "face",
      "photoUrl": "http://example.com/photo.jpg",
      "status": "normal",
      "remark": "人脸识别成功"
    }
  }
}
```

#### 1.2.2 队列入库人脸考勤
- **接口路径**: `POST /api/v1/attendance/ingest/queue/face`
- **接口描述**: 将人脸考勤记录加入队列，异步处理
- **请求参数**: 同直接入库接口
- **响应参数**:
```json
{
  "code": 200,
  "message": "success",
  "data": "queued"
}
```

#### 1.2.3 批量队列入库人脸考勤
- **接口路径**: `POST /api/v1/attendance/ingest/queue/face/bulk`
- **接口描述**: 批量将人脸考勤记录加入队列
- **请求参数**: 人脸考勤请求数组
- **响应参数**: 同单个队列入库接口

### 1.3 考勤记录查询接口

#### 1.3.1 分页查询考勤记录
- **接口路径**: `GET /api/v1/attendance/records`
- **接口描述**: 分页查询考勤记录，支持多种过滤条件
- **请求参数**:
  - `page`: int, 可选, 页码, 默认1
  - `size`: int, 可选, 每页大小, 默认10
  - `studentId`: Long, 可选, 学生ID
  - `classId`: Long, 可选, 班级ID
  - `startDate`: LocalDate, 可选, 开始日期
  - `endDate`: LocalDate, 可选, 结束日期
  - `status`: String, 可选, 考勤状态
- **响应参数**:
```json
{
  "code": 200,
  "message": "success",
  "data": {
    "total": 100,                   // Long, 总记录数
    "list": [                       // List<AttendanceRecord>, 考勤记录列表
      {
        "id": 1,
        "studentId": 1001,
        "studentName": "张三",
        "studentNo": "2024001",
        "classId": 1,
        "className": "计算机1班",
        "deviceId": 1,
        "deviceName": "东门闸机",
        "attendanceTime": "2025-01-20T08:30:00",
        "attendanceType": "in",
        "checkType": "card",
        "photoUrl": null,
        "status": "normal",
        "remark": "正常刷卡"
      }
    ]
  }
}
```

#### 1.3.2 获取指定学生考勤记录
- **接口路径**: `GET /api/v1/attendance/students/{studentId}/records`
- **接口描述**: 获取指定学生的考勤记录
- **请求参数**:
  - `studentId`: Long, 必填, 学生ID (路径参数)
  - `startDate`: LocalDate, 可选, 开始日期
  - `endDate`: LocalDate, 可选, 结束日期
- **响应参数**: 考勤记录数组

#### 1.3.3 获取考勤统计数据
- **接口路径**: `GET /api/v1/attendance/statistics`
- **接口描述**: 获取考勤统计数据
- **请求参数**:
  - `classId`: Long, 可选, 班级ID
  - `startDate`: LocalDate, 可选, 开始日期
  - `endDate`: LocalDate, 可选, 结束日期
  - `status`: String, 可选, 考勤状态
  - `checkType`: String, 可选, 考勤类型
- **响应参数**:
```json
{
  "code": 200,
  "message": "success",
  "data": {
    "totalCount": 1000,             // Long, 总考勤次数
    "normalCount": 800,             // Long, 正常考勤次数
    "lateCount": 150,               // Long, 迟到次数
    "earlyCount": 30,               // Long, 早退次数
    "absenceCount": 20,             // Long, 缺勤次数
    "attendanceRate": 0.85          // Double, 出勤率
  }
}
```

## 2. 学生和老师卡号管理接口

### 2.1 学生卡片管理接口

#### 2.1.1 列出学生卡片
- **接口路径**: `GET /api/v1/students/{id}/cards`
- **接口描述**: 列出指定学生的所有卡片
- **请求参数**:
  - `id`: Long, 必填, 学生ID (路径参数)
- **响应参数**:
```json
{
  "code": 200,
  "message": "success",
  "data": [
    {
      "id": 1,                      // Long, 卡片ID
      "cardNo": "C20240101001",     // String, 卡号
      "typeId": 1,                  // Long, 卡片类型ID
      "holderType": "STUDENT",      // String, 持卡人类型
      "holderId": "2024001",        // String, 持卡人ID (学号)
      "status": "ACTIVE",           // String, 卡片状态 (ACTIVE/LOST/FROZEN/CANCELLED)
      "balance": 100.50,            // BigDecimal, 卡片余额
      "createdAt": "2025-01-20T10:00:00",  // LocalDateTime, 创建时间
      "expireAt": null              // LocalDateTime, 过期时间 (可选)
    }
  ]
}
```

#### 2.1.2 为学生发卡
- **接口路径**: `POST /api/v1/students/{id}/cards/issue`
- **接口描述**: 为指定学生发放新卡片
- **请求参数**:
  - `id`: Long, 必填, 学生ID (路径参数)
  - 请求体:
```json
{
  "typeId": 1,                      // Long, 必填, 卡片类型ID
  "initialBalance": 50.00,          // BigDecimal, 可选, 初始余额
  "note": "新生发卡"                 // String, 可选, 备注
}
```
- **响应参数**: 返回新创建的卡片信息 (同卡片列表中的单个卡片结构)

#### 2.1.3 查询学生卡片余额
- **接口路径**: `GET /api/v1/students/{id}/cards/{cardNo}/balance`
- **接口描述**: 查询指定学生某张卡片的余额
- **请求参数**:
  - `id`: Long, 必填, 学生ID (路径参数)
  - `cardNo`: String, 必填, 卡号 (路径参数)
- **响应参数**:
```json
{
  "code": 200,
  "message": "success",
  "data": {
    "cardNo": "C20240101001",       // String, 卡号
    "balance": 100.50,              // BigDecimal, 余额
    "status": "ACTIVE",             // String, 卡片状态
    "holderType": "STUDENT",        // String, 持卡人类型
    "holderId": "2024001",          // String, 持卡人ID
    "holderName": "张三",            // String, 持卡人姓名
    "cardTypeName": "学生卡",        // String, 卡片类型名称
    "updatedAt": "2025-01-20T15:30:00"  // LocalDateTime, 最后更新时间
  }
}
```

### 2.2 教师卡片管理接口

#### 2.2.1 列出教师卡片
- **接口路径**: `GET /api/v1/teachers/{id}/cards`
- **接口描述**: 列出指定教师的所有卡片
- **请求参数**:
  - `id`: Long, 必填, 教师ID (路径参数)
- **响应参数**: 同学生卡片列表，但 `holderType` 为 "TEACHER"

#### 2.2.2 为教师发卡
- **接口路径**: `POST /api/v1/teachers/{id}/cards/issue`
- **接口描述**: 为指定教师发放新卡片
- **请求参数**: 同学生发卡接口
- **响应参数**: 同学生发卡接口

#### 2.2.3 查询教师卡片余额
- **接口路径**: `GET /api/v1/teachers/{id}/cards/{cardNo}/balance`
- **接口描述**: 查询指定教师某张卡片的余额
- **请求参数**: 同学生卡片余额查询
- **响应参数**: 同学生卡片余额查询，但 `holderType` 为 "TEACHER"

### 2.3 卡片通用管理接口

#### 2.3.1 分页查询卡片
- **接口路径**: `GET /api/v1/cards`
- **接口描述**: 分页查询所有卡片
- **请求参数**:
  - `page`: int, 可选, 页码, 默认1
  - `size`: int, 可选, 每页大小, 默认10
  - `cardNo`: String, 可选, 卡号 (模糊查询)
  - `holderType`: String, 可选, 持卡人类型
  - `holderId`: String, 可选, 持卡人ID
  - `status`: String, 可选, 卡片状态
- **响应参数**: 分页的卡片列表

#### 2.3.2 卡片类型管理
- **获取卡片类型列表**: `GET /api/v1/cards/types`
- **创建卡片类型**: `POST /api/v1/cards/types`
- **更新卡片类型**: `PUT /api/v1/cards/types/{id}`
- **删除卡片类型**: `DELETE /api/v1/cards/types/{id}`

## 3. 人脸下发到设备的接口

### 3.1 人脸批量下发接口

#### 3.1.1 批量下发人脸数据
- **接口路径**: `POST /api/v1/face/dispatch/batch`
- **接口描述**: 批量将人脸数据下发到指定设备
- **请求参数**:
```json
{
  "deviceIds": [1, 2, 3],           // List<Long>, 必填, 设备ID列表
  "personType": "STUDENT",          // String, 可选, 人员类型 (STUDENT/TEACHER)
  "personId": "2024001",            // String, 可选, 人员ID (学号/工号)
  "faceIds": [1, 2, 3]              // List<Long>, 可选, 人脸ID列表
}
```
- **响应参数**:
```json
{
  "code": 200,
  "message": "success",
  "data": {
    "taskId": "task_20250120_001",   // String, 任务ID
    "status": "PENDING",             // String, 任务状态
    "deviceCount": 3,                // Integer, 设备数量
    "faceCount": 150                 // Integer, 人脸数量
  }
}
```

### 3.2 人脸增量下发接口

#### 3.2.1 增量下发人脸数据
- **接口路径**: `POST /api/v1/face/dispatch/incremental`
- **接口描述**: 增量下发指定时间后的人脸数据
- **请求参数**:
```json
{
  "deviceIds": [1, 2, 3],           // List<Long>, 必填, 设备ID列表
  "since": "2025-01-20T00:00:00"    // LocalDateTime, 必填, 增量起始时间
}
```
- **响应参数**: 同批量下发接口

### 3.3 人脸删除接口

#### 3.3.1 删除设备人脸数据
- **接口路径**: `POST /api/v1/face/dispatch/delete`
- **接口描述**: 从指定设备删除人脸数据
- **请求参数**:
```json
{
  "deviceIds": [1, 2, 3],           // List<Long>, 必填, 设备ID列表
  "personIds": ["2024001", "2024002"]  // List<String>, 必填, 人员ID列表
}
```
- **响应参数**: 同批量下发接口

### 3.4 人脸下发任务管理接口

#### 3.4.1 查询任务列表
- **接口路径**: `GET /api/v1/face/dispatch/tasks`
- **接口描述**: 分页查询人脸下发任务列表
- **请求参数**:
  - `page`: int, 可选, 页码, 默认1
  - `size`: int, 可选, 每页大小, 默认10
  - `status`: String, 可选, 任务状态
  - `deviceId`: Long, 可选, 设备ID
- **响应参数**:
```json
{
  "code": 200,
  "message": "success",
  "data": {
    "total": 50,
    "list": [
      {
        "taskId": "task_20250120_001",
        "type": "BATCH",              // String, 任务类型 (BATCH/INCREMENTAL/DELETE)
        "status": "COMPLETED",        // String, 任务状态 (PENDING/RUNNING/COMPLETED/FAILED)
        "deviceIds": [1, 2, 3],
        "totalDevices": 3,
        "completedDevices": 3,
        "failedDevices": 0,
        "createdAt": "2025-01-20T10:00:00",
        "completedAt": "2025-01-20T10:05:00",
        "errorMessage": null
      }
    ]
  }
}
```

#### 3.4.2 查询任务详情
- **接口路径**: `GET /api/v1/face/dispatch/tasks/{taskId}`
- **接口描述**: 查询指定任务的详细信息
- **请求参数**:
  - `taskId`: String, 必填, 任务ID (路径参数)
- **响应参数**: 任务详细信息，包含每个设备的执行状态

#### 3.4.3 重试失败任务
- **接口路径**: `POST /api/v1/face/dispatch/tasks/{taskId}/retry`
- **接口描述**: 重试失败的人脸下发任务
- **请求参数**:
  - `taskId`: String, 必填, 任务ID (路径参数)
- **响应参数**: 新的任务信息

## 4. 数据结构说明

### 4.1 考勤记录 (AttendanceRecord)
```json
{
  "id": "Long, 记录ID",
  "studentId": "Long, 学生ID",
  "studentName": "String, 学生姓名",
  "studentNo": "String, 学号",
  "classId": "Long, 班级ID",
  "className": "String, 班级名称",
  "deviceId": "Long, 设备ID",
  "deviceName": "String, 设备名称",
  "attendanceTime": "LocalDateTime, 考勤时间",
  "attendanceType": "String, 考勤类型 (in/out)",
  "checkType": "String, 考勤方式 (card/face)",
  "photoUrl": "String, 照片URL (人脸考勤时有值)",
  "status": "String, 考勤状态 (normal/late/early/absence)",
  "remark": "String, 备注"
}
```

### 4.2 卡片信息 (Card)
```json
{
  "id": "Long, 卡片ID",
  "cardNo": "String, 卡号",
  "typeId": "Long, 卡片类型ID",
  "holderType": "String, 持卡人类型 (STUDENT/TEACHER/STAFF/VISITOR)",
  "holderId": "String, 持卡人ID (学号/工号)",
  "status": "String, 卡片状态 (ACTIVE/LOST/FROZEN/CANCELLED)",
  "balance": "BigDecimal, 卡片余额",
  "createdAt": "LocalDateTime, 创建时间",
  "expireAt": "LocalDateTime, 过期时间 (可选)"
}
```

### 4.3 卡片类型 (CardType)
```json
{
  "id": "Long, 类型ID",
  "name": "String, 类型名称",
  "description": "String, 类型描述"
}
```

## 5. 错误码说明

- `200`: 成功
- `400`: 请求参数错误
- `404`: 资源不存在
- `500`: 服务器内部错误

## 6. 注意事项

1. **时间格式**: 所有时间字段使用 ISO 8601 格式，如 `2025-01-20T08:30:00`
2. **队列处理**: 队列接口为异步处理，具有去重功能，相同内容的请求在当日只会处理一次
3. **人脸识别**: 人脸考勤接口会记录所有识别尝试，只有成功识别的学生记录才会生成考勤记录
4. **卡片状态**: 卡片状态影响考勤功能，只有 ACTIVE 状态的卡片才能正常考勤
5. **权限控制**: 所有接口都需要适当的权限验证
6. **数据完整性**: 考勤记录会自动关联学生、班级、设备等信息