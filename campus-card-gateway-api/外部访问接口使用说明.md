# 校园卡网关 API 外部访问接口使用说明

本文档面向外部系统调用方，介绍网关服务的访问入口、鉴权方式、可用接口、配置项及常见问题。

## 服务概览
- 基础地址：`http://{host}:8084`
- OpenAPI 文档 JSON：`/v3/api-docs`
- Swagger UI：`/swagger-ui.html`
- 运行环境：Spring Boot 2.7.x，Java 17

## 认证与安全
- 认证方式：`JWT Bearer Token`
  - 请求头携带：`Authorization: Bearer <token>`
  - 令牌签名算法：`HS256`
  - 校验要点：签名、`issuer`、过期时间（`exp`）
- 鉴权范围：除以下白名单外，其余接口均需携带有效 JWT
  - `/api/v1/gw/auth/**`（认证相关放行占位）
  - `/swagger-ui/**`、`/v3/api-docs/**`（开放文档）
  - `/actuator/**`（健康检查）
- 速率限制：按客户端 IP 简单滑动窗口限流，`60 次/分钟`
- CORS：允许来源由配置项控制，详见“配置说明”
- 错误返回格式（示例）：
  ```json
  {"code":401,"message":"Unauthorized"}
  ```

## 配置说明（application.yml）
以下为关键配置项（均位于 `gateway.auth` 前缀下）：

```yaml
gateway:
  auth:
    enabled: true                # 是否启用网关鉴权
    secret: your-32-bytes-secret # JWT 签名密钥（>=32字节，HS256）
    issuer: campus-card-gw       # 令牌签发方校验值
    expireMinutes: 60            # 访问令牌有效期（分钟）
    refreshExpireMinutes: 10080  # 刷新令牌有效期（分钟）

    # 文档访问控制
    swaggerEnabled: true         # 是否启用文档访问控制
    docAllowLocalOnly: true      # 仅本机访问文档
    docAccessSecret: doc-secret  # 远程访问文档时的保护口令（如启用）

    # CORS 跨域来源（例如前端域名）
    corsAllowedOrigins:
      - http://localhost:5173
      - https://your-frontend.example.com
```

> 说明：`secret` 必须满足 HS256 的最小密钥长度（建议 32 字节以上），否则服务无法启动。

## 接口列表（当前模块）
> 业务接口示例均位于网关模块，路径以 `api/v1/gw` 开头，默认受 JWT 保护。

- 学校列表
  - `GET /api/v1/gw/schools`
  - 响应体（示例）：
    ```json
    {
      "code": 200,
      "message": "OK",
      "data": [
        {"id":1,"name":"第一中学"},
        {"id":2,"name":"第二中学"}
      ]
    }
    ```

- 学校详情
  - `GET /api/v1/gw/schools/{id}`
  - 路径参数：`id` 学校 ID
  - 响应体（示例）：
    ```json
    {
      "code": 200,
      "message": "OK",
      "data": {"id": 123, "name": "示例学校"}
    }
    ```

> 注：如需暴露更多业务接口，可在网关模块新增 `@RestController` 或对接后端服务路由；请保持路径不在白名单内以便生效 JWT 保护。

## 使用示例

1) 查看 OpenAPI 文档 JSON（无需鉴权）
```bash
curl --noproxy '*' -i http://localhost:8084/v3/api-docs
```

2) 访问学校列表（无令牌，预期 401）
```bash
curl --noproxy '*' -i http://localhost:8084/api/v1/gw/schools
```

3) 访问学校列表（携带令牌，预期 200）
```bash
curl --noproxy '*' -i \
  -H "Authorization: Bearer <your-jwt-token>" \
  http://localhost:8084/api/v1/gw/schools
```

### JWT 令牌说明
- Header：`{"alg":"HS256","typ":"JWT"}`
- Payload（示例）：
  ```json
  {
    "sub": "user-123",
    "iss": "campus-card-gw",
    "iat": 1730170000,
    "exp": 1730173600,
    "scope": ["read"]
  }
  ```
- 签名：使用 `gateway.auth.secret` 与 HS256 生成
- 获取方式：由认证服务签发；网关仅负责校验。可在后续接入登录接口时将其挂载于 `/api/v1/gw/auth/**`。

## Swagger 访问策略
- 本地访问允许：`docAllowLocalOnly: true`
- 如需远程访问：将其设为 `false`，并可结合 `docAccessSecret` 做访问保护。
- 文档路径：`/swagger-ui.html` 与 `/v3/api-docs`

## 常见问题
- 401 Unauthorized：未携带或令牌非法/过期；检查请求头与 `issuer`、`exp`。
- 429 Too Many Requests：触发 IP 限流；降低频率或增加后端限流配额。
- 403/404：路径无权限或不存在；确认路由是否在网关模块中已注册。
- 启动失败（密钥长度）：`gateway.auth.secret` 不满足 HS256 最小长度要求。

## 变更与维护
- 扩展接口：在 `campus-card-gateway-api/src/main/java/com/campus/card/gateway/controller/` 新增控制器与路由。
- 调整安全策略：修改 `JwtAuthFilter` 或 `GatewayAuthProperties` 并重启服务。
- 文档更新：本文件位于 `campus-card-gateway-api/外部访问接口使用说明.md`。
 - 文档更新：本文件位于 `campus-card-gateway-api/外部访问接口使用说明.md`。

## 卡务与人脸接口
> 新增的业务接口均位于网关模块，路径以 `api/v1/gw` 开头，默认受 JWT 保护。

### 卡务数据
- GET `/api/v1/gw/cards/{cardNo}` 卡片信息
- GET `/api/v1/gw/cards/{cardNo}/balance` 账户余额
- GET `/api/v1/gw/cards/{cardNo}/recharges?page=1&size=10` 充值记录
- GET `/api/v1/gw/cards/{cardNo}/consumes?page=1&size=10` 消费记录

### 人脸数据
- GET `/api/v1/gw/faces/info/{personType}/{personId}` 人脸信息
- POST `/api/v1/gw/faces/upload` 人脸上传
- POST `/api/v1/gw/faces/issue` 人脸下发
- GET `/api/v1/gw/faces/recognitions?deviceId=...&start=...&end=...` 人脸识别结果

### cURL 示例

以下示例在未携带 JWT 时将返回 401，用于验证鉴权正常生效：

```bash
# 卡片信息（未携带令牌）
curl -i --noproxy '*' http://localhost:8084/api/v1/gw/cards/123456

# 人脸信息（未携带令牌）
curl -i --noproxy '*' 'http://localhost:8084/api/v1/gw/faces/info/STUDENT/S20250001'
```

携带合法 JWT 后返回 200（示例，需替换 <token> 为实际令牌）：

```bash
curl -i --noproxy '*' \
  -H 'Authorization: Bearer <token>' \
  http://localhost:8084/api/v1/gw/cards/123456
```

## 设备对接接口
> 设备相关接口位于 `/api/v1/gw/devices`，默认受 JWT 保护。

### 路由列表
- POST `/api/v1/gw/devices/register` 设备注册接口
- GET  `/api/v1/gw/devices/{deviceId}/status` 设备状态接口
- POST `/api/v1/gw/devices/{deviceId}/data` 设备数据上传接口
- POST `/api/v1/gw/devices/{deviceId}/config` 设备参数配置接口
- POST `/api/v1/gw/devices/{deviceId}/commands` 设备命令下发接口

### cURL 示例

未携带令牌（预期 401）：
```bash
curl -i --noproxy '*' \
  -X POST \
  -H 'Content-Type: application/json' \
  -d '{"deviceId":"dev-001","deviceType":"FACE_TERMINAL","model":"FT-100","location":"Gate A"}' \
  http://localhost:8084/api/v1/gw/devices/register

curl -i --noproxy '*' \
  http://localhost:8084/api/v1/gw/devices/dev-001/status
```

携带令牌（预期 200，需替换 `<token>`）：
```bash
curl -s --noproxy '*' \
  -H 'Authorization: Bearer <token>' \
  -H 'Content-Type: application/json' \
  -d '{"type":"HEARTBEAT","payload":{"cpu":0.53,"mem":0.68}}' \
  http://localhost:8084/api/v1/gw/devices/dev-001/data

curl -s --noproxy '*' \
  -H 'Authorization: Bearer <token>' \
  -H 'Content-Type: application/json' \
  -d '{"params":{"threshold":0.9,"serverUrl":"https://api.example.com","interval":30}}' \
  http://localhost:8084/api/v1/gw/devices/dev-001/config

curl -s --noproxy '*' \
  -H 'Authorization: Bearer <token>' \
  -H 'Content-Type: application/json' \
  -d '{"commandType":"REBOOT","params":{}}' \
  http://localhost:8084/api/v1/gw/devices/dev-001/commands
```